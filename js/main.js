// main.js - Entry point and event listeners (Updated version)
import { auth } from './firebase-config.js';
import { elements } from './dom-elements.js';
import { gameState, updateGameState } from './game-state.js';
import { 
  signUp, 
  signIn, 
  signOut, 
  saveDisplayName, 
  skipDisplayName,
  postLoginSetup, 
  resetUIAfterLogout, 
  logoutUser 
} from './auth.js';
import { 
  setGameDifficulty, 
  startGame, 
  showGuessMap, 
  submitGuess, 
  resetGame, 
  viewOnGoogleMap 
} from './game.js';
import { 
  adminLogin, 
  adminLogout, 
  deleteAllScores, 
  loadAdminGuesses, 
  loadGroupedGuesses,
  loadLeaderboard 
} from './admin.js';

// Global initMap function for Google Maps callback
window.initMap = () => {
  console.log('üó∫Ô∏è Google Maps API loaded successfully');
  
  // Initialize StreetViewService immediately
  if (typeof google !== 'undefined' && google.maps && google.maps.StreetViewService) {
    updateGameState({ 
      streetViewService: new google.maps.StreetViewService() 
    });
    console.log('‚úÖ StreetViewService initialized');
  } else {
    console.error('‚ùå Google Maps API not properly loaded');
  }
  
  // Load leaderboard after maps is ready
  loadLeaderboard();
  
  console.log('üó∫Ô∏è Google Maps initialization complete');
};

function initAuthListeners() {
  console.log('üîß Initializing auth listeners...');
  
  if (elements.signupBtn) {
    elements.signupBtn.addEventListener("click", signUp);
    console.log('‚úÖ Signup button listener added');
  }

  if (elements.loginBtn) {
    elements.loginBtn.addEventListener("click", signIn);
    console.log('‚úÖ Login button listener added');
  }

  if (elements.logoutUserBtn) {
    elements.logoutUserBtn.addEventListener("click", signOut);
    console.log('‚úÖ Logout user button listener added');
  }

  if (elements.fixedLogoutBtn) {
    elements.fixedLogoutBtn.addEventListener("click", logoutUser);
    console.log('‚úÖ Fixed logout button listener added');
  }

  if (elements.saveDisplayNameBtn) {
    elements.saveDisplayNameBtn.addEventListener("click", saveDisplayName);
    console.log('‚úÖ Save display name button listener added');
  }

  const skipDisplayNameBtn = document.getElementById('skipDisplayNameBtn');
  if (skipDisplayNameBtn) {
    skipDisplayNameBtn.addEventListener("click", skipDisplayName);
    console.log('‚úÖ Skip display name button listener added');
  }

  // Enter key handler for display name input
  if (elements.displayNameInput) {
    elements.displayNameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveDisplayName();
      }
    });
    console.log('‚úÖ Display name input enter key listener added');
  }

  // Enter key handlers for auth inputs
  const authInputs = [elements.userEmail, elements.userPassword];
  authInputs.forEach((input, index) => {
    if (input) {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          signIn();
        }
      });
      console.log(`‚úÖ Auth input ${index + 1} enter key listener added`);
    }
  });
}

// Game event listeners
function initGameListeners() {
  console.log('üéÆ Initializing game listeners...');
  
  // Difficulty selection buttons
  const difficultyButtons = document.querySelectorAll('[data-difficulty]');
  difficultyButtons.forEach((btn, index) => {
    btn.addEventListener('click', (e) => {
      const difficulty = e.target.getAttribute('data-difficulty');
      setGameDifficulty(difficulty);
      console.log(`üéØ Difficulty set to: ${difficulty}`);
    });
    console.log(`‚úÖ Difficulty button ${index + 1} listener added`);
  });

  // Start game button
  const startGameBtn = document.getElementById('startGameBtn');
  if (startGameBtn) {
    startGameBtn.addEventListener('click', () => {
      // Check if Google Maps is ready before starting
      if (typeof google === 'undefined' || !google.maps || !google.maps.StreetViewService) {
        alert('‚ö†Ô∏è Google Maps ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ƒë·ª£i m·ªôt ch√∫t v√† th·ª≠ l·∫°i.');
        return;
      }
      startGame();
    });
    console.log('‚úÖ Start game button listener added');
  }

  // Guess map button
  if (elements.showGuessMapBtn) {
    elements.showGuessMapBtn.addEventListener('click', showGuessMap);
    console.log('‚úÖ Show guess map button listener added');
  }

  // Submit guess button
  if (elements.submitGuessBtn) {
    elements.submitGuessBtn.addEventListener('click', submitGuess);
    console.log('‚úÖ Submit guess button listener added');
  }

  // View on Google Maps button
  if (elements.viewOnGoogleMapBtn) {
    elements.viewOnGoogleMapBtn.addEventListener('click', viewOnGoogleMap);
    console.log('‚úÖ View on Google Maps button listener added');
  }

  // Replay button
  if (elements.replayBtn) {
    elements.replayBtn.addEventListener('click', resetGame);
    console.log('‚úÖ Replay button listener added');
  }

  // Reset game button
  const resetGameBtn = document.getElementById('resetGameBtn');
  if (resetGameBtn) {
    resetGameBtn.addEventListener('click', resetGame);
    console.log('‚úÖ Reset game button listener added');
  }
}

// Admin event listeners
function initAdminListeners() {
  console.log('üîß Initializing admin listeners...');
  
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  if (adminLoginBtn) {
    adminLoginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('üîê Admin login button clicked');
      adminLogin();
    });
    console.log('‚úÖ Admin login button listener added');
  } else {
    console.log('‚ùå Admin login button not found');
  }

  const adminLogoutBtn = document.getElementById('adminLogoutBtn');
  if (adminLogoutBtn) {
    adminLogoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('üö™ Admin logout button clicked');
      adminLogout();
    });
    console.log('‚úÖ Admin logout button listener added');
  } else {
    console.log('‚ùå Admin logout button not found');
  }

  const deleteBtn = document.getElementById('deleteBtn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('üóëÔ∏è Delete button clicked');
      deleteAllScores();
    });
    console.log('‚úÖ Delete button listener added');
  } else {
    console.log('‚ùå Delete button not found');
  }

  const loadGuessesBtn = document.getElementById('loadGuessesBtn');
  if (loadGuessesBtn) {
    loadGuessesBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('üìä Load guesses button clicked');
      loadAdminGuesses();
    });
    console.log('‚úÖ Load guesses button listener added');
  } else {
    console.log('‚ùå Load guesses button not found');
  }

  const loadGroupedBtn = document.getElementById('loadGroupedBtn');
  if (loadGroupedBtn) {
    loadGroupedBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('üìÖ Load grouped button clicked');
      loadGroupedGuesses();
    });
    console.log('‚úÖ Load grouped button listener added');
  } else {
    console.log('‚ùå Load grouped button not found');
  }

  // Enter key handlers for admin inputs
  const adminEmail = document.getElementById('adminEmail');
  const adminPassword = document.getElementById('adminPassword');
  
  if (adminEmail) {
    adminEmail.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adminLogin();
      }
    });
    console.log('‚úÖ Admin email enter key listener added');
  }
  
  if (adminPassword) {
    adminPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        adminLogin();
      }
    });
    console.log('‚úÖ Admin password enter key listener added');
  }
}

// Auth state change handler
function initAuthStateListener() {
  console.log('üîê Initializing auth state listener...');
  
  // Fixed: Use firebase.auth() instead of auth
  firebase.auth().onAuthStateChanged(async (user) => {
    if (user) {
      if (elements.fixedLogoutBtn) {
        elements.fixedLogoutBtn.classList.remove("hidden");
      }
      console.log('üîÑ User logged in:', user.email);
      await postLoginSetup(user);
    } else {
      console.log('üö™ User logged out');
      resetUIAfterLogout();
      if (elements.fixedLogoutBtn) {
        elements.fixedLogoutBtn.classList.add("hidden");
      }
    }
  });
  
  console.log('‚úÖ Auth state listener initialized');
}

// Global function exports for HTML onclick handlers (backup)
window.setGameDifficulty = setGameDifficulty;
window.startGame = startGame;
window.showGuessMap = showGuessMap;
window.submitGuess = submitGuess;
window.resetGame = resetGame;
window.viewOnGoogleMap = viewOnGoogleMap;
window.logoutUser = logoutUser;
window.adminLogin = adminLogin;
window.adminLogout = adminLogout;
window.deleteAllScores = deleteAllScores;
window.loadAdminGuesses = loadAdminGuesses;
window.loadGroupedGuesses = loadGroupedGuesses;

// Initialize application
function initApp() {
  console.log('üöÄ Initializing GeoGuesser application...');
  
  try {
    // Check if Firebase is loaded
    if (typeof firebase === 'undefined') {
      throw new Error('Firebase not loaded. Please check your script tags.');
    }
    
    // Check if all required elements exist
    const requiredElements = [
      'authContainer', 'difficultyContainer', 'gameContainer', 
      'adminLoginContainer', 'userEmail', 'userPassword'
    ];
    
    const missingElements = requiredElements.filter(id => !document.getElementById(id));
    if (missingElements.length > 0) {
      console.warn('‚ö†Ô∏è Missing elements:', missingElements);
    }
    
    initAuthListeners();
    initGameListeners();
    initAdminListeners();
    initAuthStateListener();
    
    console.log('‚úÖ Application initialized successfully');
    
    // Wait for Google Maps to be ready before loading leaderboard
    const waitForMapsAndLoadBoard = () => {
      if (typeof google !== 'undefined' && google.maps) {
        loadLeaderboard();
      } else {
        setTimeout(waitForMapsAndLoadBoard, 1000);
      }
    };
    waitForMapsAndLoadBoard();
    
  } catch (error) {
    console.error('‚ùå Error initializing application:', error);
    alert('C√≥ l·ªói khi kh·ªüi ƒë·ªông ·ª©ng d·ª•ng: ' + error.message);
  }
}

// Debug function to check admin elements
function checkAdminElements() {
  const adminElements = [
    'adminLoginBtn', 'adminLogoutBtn', 'deleteBtn', 
    'loadGuessesBtn', 'loadGroupedBtn', 'adminEmail', 'adminPassword'
  ];
  
  console.log('üîç Checking admin elements:');
  adminElements.forEach(id => {
    const element = document.getElementById(id);
    console.log(`${element ? '‚úÖ' : '‚ùå'} ${id}:`, element);
  });
}

// Enhanced debug functions
function debugAdminElements() {
  console.log('üîç DEBUGGING ADMIN ELEMENTS:');
  
  const adminElements = [
    'adminLoginContainer',
    'adminSection', 
    'adminEmail',
    'adminPassword',
    'adminLoginBtn',
    'adminLogoutBtn',
    'deleteBtn',
    'loadGuessesBtn',
    'loadGroupedBtn',
    'adminControls',
    'adminGuessesContainer',
    'adminHistoryGrouped',
    'adminGuessesBody'
  ];
  
  adminElements.forEach(id => {
    const element = document.getElementById(id);
    console.log(`${element ? '‚úÖ' : '‚ùå'} ${id}:`, element);
    
    if (element) {
      console.log(`   - Display: ${getComputedStyle(element).display}`);
      console.log(`   - Visibility: ${getComputedStyle(element).visibility}`);
      console.log(`   - Classes: ${element.className}`);
    }
  });
}

function forceShowAdminElements() {
  console.log('üîß FORCE SHOWING ADMIN ELEMENTS:');
  
  const elementsToShow = [
    'adminLogoutBtn',
    'deleteBtn', 
    'loadGuessesBtn',
    'loadGroupedBtn',
    'adminControls'
  ];
  
  elementsToShow.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.classList.remove('hidden');
      element.style.display = 'block';
      element.style.visibility = 'visible';
      console.log(`‚úÖ Forced show: ${id}`);
    } else {
      console.log(`‚ùå Element not found: ${id}`);
    }
  });
}

// Global debug functions
window.debugAdminElements = debugAdminElements;
window.forceShowAdminElements = forceShowAdminElements;

// Start the application when DOM is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    initApp();
    // Debug admin elements
    setTimeout(checkAdminElements, 500);
  });
} else {
  initApp();
  // Debug admin elements
  setTimeout(checkAdminElements, 500);
}

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && gameState.isAdminLoggedIn) {
    // Refresh admin data when page becomes visible
    loadLeaderboard();
  }
});

// Handle window beforeunload
window.addEventListener('beforeunload', (e) => {
  if (gameState.score > 0) {
    e.preventDefault();
    e.returnValue = 'B·∫°n c√≥ mu·ªën r·ªùi kh·ªèi trang? ƒêi·ªÉm s·ªë hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.';
    return e.returnValue;
  }
});

// Error handling
window.addEventListener('error', (e) => {
  console.error('‚ùå Global error:', e.error);
});

window.addEventListener('unhandledrejection', (e) => {
  console.error('‚ùå Unhandled promise rejection:', e.reason);
});

console.log('üì± Main.js loaded successfully');